### Project ChatRoom


实现 GNU/Linux 环境下采用C/S模型的简易聊天室。


### 项目需求

#### 账号管理

- 实现登录、注册、注销

  方案：自动分配一个序号

- 实现找回密码（提高）

- 实现验证码注册/找回（邮件/手机号等）（提高）

- 实现数据加密（提高）


#### 好友管理

- 实现好友的添加、删除、查询操作

  方案：分为序号和名称

- 实现显示好友在线状态

  方案：成员类中的属性

- 禁止不存在好友关系的用户间的私聊

  方案：选择对象后才能有其他操作

- 实现屏蔽好友消息

- 实现好友间聊天

  


#### 群管理

- 实现群组的创建、解散
- 实现用户申请加入群组
- 实现用户查看已加入的群组
- 实现群组成员退出已加入的群组
- 实现群组成员查看群组成员列表
- 实现群主对群组管理员的添加和删除
- 实现群组管理员批准用户加入群组
- 实现群组管理员/群主从群组中移除用户
- 实现群组内聊天功能

#### 聊天功能

对于 **私聊和群组** 的聊天功能**均需要**实现：

- 实现查看历史消息记录

- 实现用户间在线聊天

- 实现在线用户对离线用户发送消息，离线用户上线后获得通知

  方案：离线状态放到一个消息队列，//在线后先检测list是否为空

  

- 实现文件发送的断点续传（提高）

- 实现在线发送文件

  方案：sendfile？封装一个类（文件名，数据），单写一个函数来接收

- 实现在线用户对离线用户发送文件，离线用户上线后获得通知/接收（提高）

- 实现用户在线时,消息的实时通知
	- 收到好友请求
	
	- 收到私聊
	
	- 收到加群申请
	
	  方案：用信号处理程序，判断与当前打开的窗口是否相同，不同就解析粗略输出
	
  - ...

#### 其他要求

- 使用 I/O 多路复用完成本项目

     > C++/Golang – epoll ET 模式
     >
     > Java – netty 和 NIO 

- 使用数据库完成数据存储

  > C++/Golang --  Redis 或 levelDB
  >
  > Java -- Mysql/mariadb/任意RDBMS

- 实现图形化界面（超级提高）

- 数据库中数据的存储和取用使用序列化和反序列化完成(Json/Proto等)(提高)

- 撰写用户文档

- 支持大量客户端同时访问

     方案：并发型tcp服务器

- 实现服务器日志，记录服务器的状态信息

     方案：syslog

- 实现具有高稳定性的客户端和服务器，防止在用户非法输入时崩溃或异常
  - 实现 TCP 心跳检测 //因为tcp自带的心跳检测在重传机制之后，所以需要用户态的心跳检测,还可以定制其他信息

    方案：？？？

- 界面美观

- 请将源码合理的拆分在多个文件中，项目的构建使用 
		
	> C++   ---  bazel（推荐）、cmake、ninja、makefile（不推荐）中任意一个
	>
	> Java  ---- Maven/Gradle 任意一个.
	
- 项目引入外部的日志库或单元测试库。

   > C++  — gtest glog 等
   >
   > Java – Junit Log4j/log4j2等

- 提高功能必须选择1，2个完成



## 想法

服务器端

主线程一直在listen，每多一个连接开一个线程连接 (好像不用)加进epoll EPOLLET 用边缘触发

还有一个线程一直在epoll_wait(,,-1)，通过读到的权限调用不同函数，如果是在线聊天用epoll_ctl()将文件句柄改为EPOLLONESHOT，再单独开一个线程去循环堵塞read



数据库存储用户（id，username,password,online,list<好友、群>，等待接收队列）、群组信息(ID,map<用户名、ID,权限>，set<加入申请>)和聊天记录(每个用户各自存各自的)（的json）



客户端

//一个线程在我们不在与服务端交互时（epoll收到消息通知）持锁read来实时通知（另一个线程在交互时上锁，不交互时wait）

或者在收到消息时，发出信号，发出选项等待回应时抛弃信号，信号处理程序是实时通知//问题：数据量大时信号会被忽略，输出线程不安全（单开一个进程去输出？）

多路复用被信号中断不会自动重启

SA_RESTART  

或者就做一个flag标识收到的是不是回应，//服务客户都要改，把发送接收在包装一下



Manage_Apply_UI(int ID) // 移到friend里



将选项发给服务器；

聊天信息包括个人信息（用户名，时间）（包装成消息类），对端信息（用json序列化）

或者先发一个对端信息再发序列化的消息类



不需要新建一个类 只多了一个权限变量

//用户类和群组中的成员类要分开或者继承同一个更简单的类



组

成员：map<userID,权限>，chatID，set<message\>待处理信息





问题： // UserTotal(int ID, string account, string password, bool islogin);//说在UserTotal类中找不到这些成员

2.收文件时，若已存在，先读文件的hash，不一样的话再新建文件

3.返回聊天记录时返回一定数量，客户端收时收完头循环收体

已解决：

1.静态（成员）变量要在声明外定义，最好不要用函数返回值初始化静态（成员）变量

2.// flag = ~flag;有问题，按1字节按位取反

bool flag = !flag;

3.expected initializer before“***”，某个声明没加; 

4.undefined reference to XXX，某个类中成员声明时没有（类名::），少头文件，cmake配置不全

5.jump to case label 不要在case里定义变量，或者加个{}限制生命周期

6.输ID时输入字符会死循环，在客户端输入ID等数字时用string接收传输时转成int

//生成ID后转为string，之后都只用string
